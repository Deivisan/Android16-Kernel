version: '3.8'

services:
  kernel-build:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        UBUNTU_VERSION: 20.04
        USERNAME: builder
        USER_UID: ${UID:-1000}
        USER_GID: ${GID:-1000}

    image: moonstone-kernel-builder:latest
    container_name: moonstone-kernel-build

    # Volumes
    volumes:
      # Kernel source (read-only para seguranÃ§a)
      - /home/deivi/Projetos/Android16-Kernel/kernel-moonstone-devs:/kernel:ro
      # Output do build (read-write)
      - /home/deivi/Projetos/Android16-Kernel/laboratorio/out:/output
      # ccache para acelerar rebuilds
      - /home/deivi/.ccache:/ccache
      # Logs do build
      - /home/deivi/Projetos/Android16-Kernel/laboratorio/logs:/logs

    # Resource limits (ajustar conforme hardware)
    deploy:
      resources:
        limits:
          cpus: '8'        # 8 vCPUs
          memory: 8G        # 8GB RAM
        reservations:
          cpus: '4'        # MÃ­nimo 4 vCPUs
          memory: 4G        # MÃ­nimo 4GB RAM

    # VariÃ¡veis de ambiente
    environment:
      - ARCH=arm64
      - SUBARCH=arm64
      - CROSS_COMPILE=aarch64-linux-gnu-
      - CC=clang
      - CLANG_TRIPLE=aarch64-linux-gnu-
      - KCFLAGS=-O2
      - KAFLAGS=-O2

    # ConfiguraÃ§Ãµes de network
    network_mode: bridge

    # Comando padrÃ£o (pode ser sobrescrito)
    command: /bin/bash -c "
      echo 'ðŸ¦ž DevSan Kernel Build Environment - Moonstone' && \
      echo 'ðŸ“¦ Kernel: /kernel (ro)' && \
      echo 'ðŸ“¤ Output: /output' && \
      echo 'ðŸ’¾ Cache: /ccache' && \
      echo 'âš¡ Clang: r416183b (Android 12.0.8)' && \
      /bin/bash --login
    "

    # Keep container running
    stdin_open: true
    tty: true

    # Hostname
    hostname: moonstone-builder
